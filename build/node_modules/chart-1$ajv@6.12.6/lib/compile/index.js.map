{"version":3,"sources":["index.js"],"names":["resolve","require","util","errorClasses","stableStringify","validateGenerator","ucs2length","equal","ValidationError","Validation","module","exports","compile","schema","root","localRefs","baseId","self","opts","_opts","refVal","undefined","refs","patterns","patternsHash","defaults","defaultsHash","customRules","c","checkCompiling","call","compilation","_compilations","index","compiling","callValidate","formats","_formats","RULES","v","localCompile","validate","cv","errors","$async","sourceCode","source","endCompiling","result","apply","arguments","_schema","_root","isRoot","isTop","schemaPath","errSchemaPath","errorPath","MissingRefError","MissingRef","resolveRef","usePattern","useDefault","useCustomRule","logger","vars","refValCode","patternCode","defaultCode","customRuleCode","processCode","makeValidate","Function","e","error","code","ref","url","refIndex","_refVal","refCode","resolvedRef","rootRefId","addLocalRef","localSchema","inlineRef","inlineRefs","removeLocalRef","replaceLocalRef","refId","length","inline","regexStr","value","toQuotedString","valueStr","rule","parentSchema","it","validateSchema","deps","definition","dependencies","every","keyword","Object","prototype","hasOwnProperty","Error","join","valid","message","errorsText","macro","compIndex","i","splice","arr","statement"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\nvar resolve = require('./resolve')\n  , util = require('./util')\n  , errorClasses = require('./error_classes')\n  , stableStringify = require('fast-json-stable-stringify');\n\nvar validateGenerator = require('../dotjs/validate');\n\n/**\n * Functions below are used inside compiled validations function\n */\n\nvar ucs2length = util.ucs2length;\nvar equal = require('fast-deep-equal');\n\n// this error is thrown by async schemas to return validation errors via exception\nvar ValidationError = errorClasses.Validation;\n\nmodule.exports = compile;\n\n\n/**\n * Compiles schema to validation function\n * @this   Ajv\n * @param  {Object} schema schema object\n * @param  {Object} root object with information about the root schema for this schema\n * @param  {Object} localRefs the hash of local references inside the schema (created by resolve.id), used for inline resolution\n * @param  {String} baseId base ID for IDs in the schema\n * @return {Function} validation function\n */\nfunction compile(schema, root, localRefs, baseId) {\n  /* jshint validthis: true, evil: true */\n  /* eslint no-shadow: 0 */\n  var self = this\n    , opts = this._opts\n    , refVal = [ undefined ]\n    , refs = {}\n    , patterns = []\n    , patternsHash = {}\n    , defaults = []\n    , defaultsHash = {}\n    , customRules = [];\n\n  root = root || { schema: schema, refVal: refVal, refs: refs };\n\n  var c = checkCompiling.call(this, schema, root, baseId);\n  var compilation = this._compilations[c.index];\n  if (c.compiling) return (compilation.callValidate = callValidate);\n\n  var formats = this._formats;\n  var RULES = this.RULES;\n\n  try {\n    var v = localCompile(schema, root, localRefs, baseId);\n    compilation.validate = v;\n    var cv = compilation.callValidate;\n    if (cv) {\n      cv.schema = v.schema;\n      cv.errors = null;\n      cv.refs = v.refs;\n      cv.refVal = v.refVal;\n      cv.root = v.root;\n      cv.$async = v.$async;\n      if (opts.sourceCode) cv.source = v.source;\n    }\n    return v;\n  } finally {\n    endCompiling.call(this, schema, root, baseId);\n  }\n\n  /* @this   {*} - custom context, see passContext option */\n  function callValidate() {\n    /* jshint validthis: true */\n    var validate = compilation.validate;\n    var result = validate.apply(this, arguments);\n    callValidate.errors = validate.errors;\n    return result;\n  }\n\n  function localCompile(_schema, _root, localRefs, baseId) {\n    var isRoot = !_root || (_root && _root.schema == _schema);\n    if (_root.schema != root.schema)\n      return compile.call(self, _schema, _root, localRefs, baseId);\n\n    var $async = _schema.$async === true;\n\n    var sourceCode = validateGenerator({\n      isTop: true,\n      schema: _schema,\n      isRoot: isRoot,\n      baseId: baseId,\n      root: _root,\n      schemaPath: '',\n      errSchemaPath: '#',\n      errorPath: '\"\"',\n      MissingRefError: errorClasses.MissingRef,\n      RULES: RULES,\n      validate: validateGenerator,\n      util: util,\n      resolve: resolve,\n      resolveRef: resolveRef,\n      usePattern: usePattern,\n      useDefault: useDefault,\n      useCustomRule: useCustomRule,\n      opts: opts,\n      formats: formats,\n      logger: self.logger,\n      self: self\n    });\n\n    sourceCode = vars(refVal, refValCode) + vars(patterns, patternCode)\n                   + vars(defaults, defaultCode) + vars(customRules, customRuleCode)\n                   + sourceCode;\n\n    if (opts.processCode) sourceCode = opts.processCode(sourceCode, _schema);\n    // console.log('\\n\\n\\n *** \\n', JSON.stringify(sourceCode));\n    var validate;\n    try {\n      var makeValidate = new Function(\n        'self',\n        'RULES',\n        'formats',\n        'root',\n        'refVal',\n        'defaults',\n        'customRules',\n        'equal',\n        'ucs2length',\n        'ValidationError',\n        sourceCode\n      );\n\n      validate = makeValidate(\n        self,\n        RULES,\n        formats,\n        root,\n        refVal,\n        defaults,\n        customRules,\n        equal,\n        ucs2length,\n        ValidationError\n      );\n\n      refVal[0] = validate;\n    } catch(e) {\n      self.logger.error('Error compiling schema, function code:', sourceCode);\n      throw e;\n    }\n\n    validate.schema = _schema;\n    validate.errors = null;\n    validate.refs = refs;\n    validate.refVal = refVal;\n    validate.root = isRoot ? validate : _root;\n    if ($async) validate.$async = true;\n    if (opts.sourceCode === true) {\n      validate.source = {\n        code: sourceCode,\n        patterns: patterns,\n        defaults: defaults\n      };\n    }\n\n    return validate;\n  }\n\n  function resolveRef(baseId, ref, isRoot) {\n    ref = resolve.url(baseId, ref);\n    var refIndex = refs[ref];\n    var _refVal, refCode;\n    if (refIndex !== undefined) {\n      _refVal = refVal[refIndex];\n      refCode = 'refVal[' + refIndex + ']';\n      return resolvedRef(_refVal, refCode);\n    }\n    if (!isRoot && root.refs) {\n      var rootRefId = root.refs[ref];\n      if (rootRefId !== undefined) {\n        _refVal = root.refVal[rootRefId];\n        refCode = addLocalRef(ref, _refVal);\n        return resolvedRef(_refVal, refCode);\n      }\n    }\n\n    refCode = addLocalRef(ref);\n    var v = resolve.call(self, localCompile, root, ref);\n    if (v === undefined) {\n      var localSchema = localRefs && localRefs[ref];\n      if (localSchema) {\n        v = resolve.inlineRef(localSchema, opts.inlineRefs)\n            ? localSchema\n            : compile.call(self, localSchema, root, localRefs, baseId);\n      }\n    }\n\n    if (v === undefined) {\n      removeLocalRef(ref);\n    } else {\n      replaceLocalRef(ref, v);\n      return resolvedRef(v, refCode);\n    }\n  }\n\n  function addLocalRef(ref, v) {\n    var refId = refVal.length;\n    refVal[refId] = v;\n    refs[ref] = refId;\n    return 'refVal' + refId;\n  }\n\n  function removeLocalRef(ref) {\n    delete refs[ref];\n  }\n\n  function replaceLocalRef(ref, v) {\n    var refId = refs[ref];\n    refVal[refId] = v;\n  }\n\n  function resolvedRef(refVal, code) {\n    return typeof refVal == 'object' || typeof refVal == 'boolean'\n            ? { code: code, schema: refVal, inline: true }\n            : { code: code, $async: refVal && !!refVal.$async };\n  }\n\n  function usePattern(regexStr) {\n    var index = patternsHash[regexStr];\n    if (index === undefined) {\n      index = patternsHash[regexStr] = patterns.length;\n      patterns[index] = regexStr;\n    }\n    return 'pattern' + index;\n  }\n\n  function useDefault(value) {\n    switch (typeof value) {\n      case 'boolean':\n      case 'number':\n        return '' + value;\n      case 'string':\n        return util.toQuotedString(value);\n      case 'object':\n        if (value === null) return 'null';\n        var valueStr = stableStringify(value);\n        var index = defaultsHash[valueStr];\n        if (index === undefined) {\n          index = defaultsHash[valueStr] = defaults.length;\n          defaults[index] = value;\n        }\n        return 'default' + index;\n    }\n  }\n\n  function useCustomRule(rule, schema, parentSchema, it) {\n    if (self._opts.validateSchema !== false) {\n      var deps = rule.definition.dependencies;\n      if (deps && !deps.every(function(keyword) {\n        return Object.prototype.hasOwnProperty.call(parentSchema, keyword);\n      }))\n        throw new Error('parent schema must have all required keywords: ' + deps.join(','));\n\n      var validateSchema = rule.definition.validateSchema;\n      if (validateSchema) {\n        var valid = validateSchema(schema);\n        if (!valid) {\n          var message = 'keyword schema is invalid: ' + self.errorsText(validateSchema.errors);\n          if (self._opts.validateSchema == 'log') self.logger.error(message);\n          else throw new Error(message);\n        }\n      }\n    }\n\n    var compile = rule.definition.compile\n      , inline = rule.definition.inline\n      , macro = rule.definition.macro;\n\n    var validate;\n    if (compile) {\n      validate = compile.call(self, schema, parentSchema, it);\n    } else if (macro) {\n      validate = macro.call(self, schema, parentSchema, it);\n      if (opts.validateSchema !== false) self.validateSchema(validate, true);\n    } else if (inline) {\n      validate = inline.call(self, it, rule.keyword, schema, parentSchema);\n    } else {\n      validate = rule.definition.validate;\n      if (!validate) return;\n    }\n\n    if (validate === undefined)\n      throw new Error('custom keyword \"' + rule.keyword + '\"failed to compile');\n\n    var index = customRules.length;\n    customRules[index] = validate;\n\n    return {\n      code: 'customRule' + index,\n      validate: validate\n    };\n  }\n}\n\n\n/**\n * Checks if the schema is currently compiled\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n * @return {Object} object with properties \"index\" (compilation index) and \"compiling\" (boolean)\n */\nfunction checkCompiling(schema, root, baseId) {\n  /* jshint validthis: true */\n  var index = compIndex.call(this, schema, root, baseId);\n  if (index >= 0) return { index: index, compiling: true };\n  index = this._compilations.length;\n  this._compilations[index] = {\n    schema: schema,\n    root: root,\n    baseId: baseId\n  };\n  return { index: index, compiling: false };\n}\n\n\n/**\n * Removes the schema from the currently compiled list\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n */\nfunction endCompiling(schema, root, baseId) {\n  /* jshint validthis: true */\n  var i = compIndex.call(this, schema, root, baseId);\n  if (i >= 0) this._compilations.splice(i, 1);\n}\n\n\n/**\n * Index of schema compilation in the currently compiled list\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n * @return {Integer} compilation index\n */\nfunction compIndex(schema, root, baseId) {\n  /* jshint validthis: true */\n  for (var i=0; i<this._compilations.length; i++) {\n    var c = this._compilations[i];\n    if (c.schema == schema && c.root == root && c.baseId == baseId) return i;\n  }\n  return -1;\n}\n\n\nfunction patternCode(i, patterns) {\n  return 'var pattern' + i + ' = new RegExp(' + util.toQuotedString(patterns[i]) + ');';\n}\n\n\nfunction defaultCode(i) {\n  return 'var default' + i + ' = defaults[' + i + '];';\n}\n\n\nfunction refValCode(i, refVal) {\n  return refVal[i] === undefined ? '' : 'var refVal' + i + ' = refVal[' + i + '];';\n}\n\n\nfunction customRuleCode(i) {\n  return 'var customRule' + i + ' = customRules[' + i + '];';\n}\n\n\nfunction vars(arr, statement) {\n  if (!arr.length) return '';\n  var code = '';\n  for (var i=0; i<arr.length; i++)\n    code += statement(i, arr);\n  return code;\n}\n"]}