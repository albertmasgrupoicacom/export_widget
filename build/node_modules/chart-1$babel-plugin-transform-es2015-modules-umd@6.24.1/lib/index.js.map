{"version":3,"sources":["index.js"],"names":["exports","__esModule","default","_ref","t","types","isValidDefine","path","isExpressionStatement","expr","get","isCallExpression","isIdentifier","name","args","length","shift","isStringLiteral","isArrayExpression","isFunctionExpression","inherits","require","visitor","Program","exit","state","last","pop","call","node","expression","arguments","moduleName","amdArgs","func","browserGlobals","opts","globals","commonArgs","elements","map","arg","value","identifier","callExpression","browserArgs","memberExpression","exactGlobals","globalRef","split","reduce","accum","curr","toIdentifier","requireName","_path","basename","extname","globalName","moduleNameOrBasename","file","globalToAssign","prerequisiteAssignments","members","slice","push","buildPrerequisiteAssignment","GLOBAL_REFERENCE","globalExport","buildGlobalExport","BROWSER_ARGUMENTS","PREREQUISITE_ASSIGNMENTS","GLOBAL_TO_ASSIGN","replaceWith","buildWrapper","MODULE_NAME","AMD_ARGUMENTS","COMMON_ARGUMENTS","GLOBAL_EXPORT","FUNC","_babelTemplate","_babelTemplate2","_interopRequireDefault","obj","module"],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\n\nexports.__esModule = true;\n\nexports.default = function (_ref) {\n  var t = _ref.types;\n\n  function isValidDefine(path) {\n    if (!path.isExpressionStatement()) return;\n\n    var expr = path.get(\"expression\");\n    if (!expr.isCallExpression()) return false;\n    if (!expr.get(\"callee\").isIdentifier({ name: \"define\" })) return false;\n\n    var args = expr.get(\"arguments\");\n    if (args.length === 3 && !args.shift().isStringLiteral()) return false;\n    if (args.length !== 2) return false;\n    if (!args.shift().isArrayExpression()) return false;\n    if (!args.shift().isFunctionExpression()) return false;\n\n    return true;\n  }\n\n  return {\n    inherits: require(\"babel-plugin-transform-es2015-modules-amd\"),\n\n    visitor: {\n      Program: {\n        exit: function exit(path, state) {\n          var last = path.get(\"body\").pop();\n          if (!isValidDefine(last)) return;\n\n          var call = last.node.expression;\n          var args = call.arguments;\n\n          var moduleName = args.length === 3 ? args.shift() : null;\n          var amdArgs = call.arguments[0];\n          var func = call.arguments[1];\n          var browserGlobals = state.opts.globals || {};\n\n          var commonArgs = amdArgs.elements.map(function (arg) {\n            if (arg.value === \"module\" || arg.value === \"exports\") {\n              return t.identifier(arg.value);\n            } else {\n              return t.callExpression(t.identifier(\"require\"), [arg]);\n            }\n          });\n\n          var browserArgs = amdArgs.elements.map(function (arg) {\n            if (arg.value === \"module\") {\n              return t.identifier(\"mod\");\n            } else if (arg.value === \"exports\") {\n              return t.memberExpression(t.identifier(\"mod\"), t.identifier(\"exports\"));\n            } else {\n              var memberExpression = void 0;\n\n              if (state.opts.exactGlobals) {\n                var globalRef = browserGlobals[arg.value];\n                if (globalRef) {\n                  memberExpression = globalRef.split(\".\").reduce(function (accum, curr) {\n                    return t.memberExpression(accum, t.identifier(curr));\n                  }, t.identifier(\"global\"));\n                } else {\n                  memberExpression = t.memberExpression(t.identifier(\"global\"), t.identifier(t.toIdentifier(arg.value)));\n                }\n              } else {\n                var requireName = (0, _path.basename)(arg.value, (0, _path.extname)(arg.value));\n                var globalName = browserGlobals[requireName] || requireName;\n                memberExpression = t.memberExpression(t.identifier(\"global\"), t.identifier(t.toIdentifier(globalName)));\n              }\n\n              return memberExpression;\n            }\n          });\n\n          var moduleNameOrBasename = moduleName ? moduleName.value : this.file.opts.basename;\n          var globalToAssign = t.memberExpression(t.identifier(\"global\"), t.identifier(t.toIdentifier(moduleNameOrBasename)));\n          var prerequisiteAssignments = null;\n\n          if (state.opts.exactGlobals) {\n            var globalName = browserGlobals[moduleNameOrBasename];\n\n            if (globalName) {\n              prerequisiteAssignments = [];\n\n              var members = globalName.split(\".\");\n              globalToAssign = members.slice(1).reduce(function (accum, curr) {\n                prerequisiteAssignments.push(buildPrerequisiteAssignment({ GLOBAL_REFERENCE: accum }));\n                return t.memberExpression(accum, t.identifier(curr));\n              }, t.memberExpression(t.identifier(\"global\"), t.identifier(members[0])));\n            }\n          }\n\n          var globalExport = buildGlobalExport({\n            BROWSER_ARGUMENTS: browserArgs,\n            PREREQUISITE_ASSIGNMENTS: prerequisiteAssignments,\n            GLOBAL_TO_ASSIGN: globalToAssign\n          });\n\n          last.replaceWith(buildWrapper({\n            MODULE_NAME: moduleName,\n            AMD_ARGUMENTS: amdArgs,\n            COMMON_ARGUMENTS: commonArgs,\n            GLOBAL_EXPORT: globalExport,\n            FUNC: func\n          }));\n        }\n      }\n    }\n  };\n};\n\nvar _path = require(\"path\");\n\nvar _babelTemplate = require(\"babel-template\");\n\nvar _babelTemplate2 = _interopRequireDefault(_babelTemplate);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar buildPrerequisiteAssignment = (0, _babelTemplate2.default)(\"\\n  GLOBAL_REFERENCE = GLOBAL_REFERENCE || {}\\n\");\n\nvar buildGlobalExport = (0, _babelTemplate2.default)(\"\\n  var mod = { exports: {} };\\n  factory(BROWSER_ARGUMENTS);\\n  PREREQUISITE_ASSIGNMENTS\\n  GLOBAL_TO_ASSIGN = mod.exports;\\n\");\n\nvar buildWrapper = (0, _babelTemplate2.default)(\"\\n  (function (global, factory) {\\n    if (typeof define === \\\"function\\\" && define.amd) {\\n      define(MODULE_NAME, AMD_ARGUMENTS, factory);\\n    } else if (typeof exports !== \\\"undefined\\\") {\\n      factory(COMMON_ARGUMENTS);\\n    } else {\\n      GLOBAL_EXPORT\\n    }\\n  })(this, FUNC);\\n\");\n\nmodule.exports = exports[\"default\"];"]}